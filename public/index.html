<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proactive Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Proactive</h2>
    <section>
      <h3>Menu</h3>
      <button class="menu-btn" onclick="window.location.href='daily_goals.html'">
        Daily Goals
      </button>
      <button class="menu-btn" onclick="window.location.href='course_modules.html'">
        Course Modules
      </button>
      <button class="menu-btn" onclick="window.location.href='milestones.html'">
        Milestones
      </button>
    </section>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <header class="header">
      <div class="streak" id="streak">ðŸ”¥ Streak: 1</div>

      <!-- User area: JS will populate Sign In / Sign Up or user name -->
      <div id="userArea" class="profile"></div>
    </header>

    <section class="content" id="content">
      <h3>Welcome to Proactive Dashboard</h3>
      <p>Select an item from the sidebar to get started.</p>
    </section>
  </main>

  <script>
    const content = document.getElementById("content");
    const userArea = document.getElementById("userArea");
    const userId = localStorage.getItem("userId");
    const userName = localStorage.getItem("userName") || "User";
    

    // Update header: Sign In / Sign Up or User Name
    if(userName||userId) {
      // User signed in â†’ show name button with dropdown
      userArea.innerHTML = `
        <button id="userBtn" class="menu-btn" style="background:#0B2E33; color:white; font-weight:600;">
          Hi, ${userName}
        </button>
        <div class="profile-menu">
          <a href="profile.html">Profile</a>
          <a href="calendar.html">Calendar</a>
          <a href="progress.html">Progress</a>
          <a href="notebook.html">Notebook</a>
          <a href="signin.html" id="signOut">Sign Out</a>
        </div>
      `;

      const userBtn = document.getElementById("userBtn");
      const menu = userArea.querySelector(".profile-menu");

      userBtn.addEventListener("click", e => {
        e.stopPropagation();
        menu.classList.toggle("active");
      });

      document.addEventListener("click", () => menu.classList.remove("active"));

      document.getElementById("signOut").addEventListener("click", () => {
        localStorage.removeItem("userId");
        localStorage.removeItem("userName");
        location.reload();
      });

    } else {
      // User not signed in â†’ show Sign In / Sign Up buttons
      userArea.innerHTML = `
        <button onclick="window.location.href='signin.html'" class="menu-btn" style="background:#0B2E33; color:white; font-weight:600; margin-right:5px;">
          Sign In
        </button>
        <button onclick="window.location.href='signup.html'" class="menu-btn" style="background:#0B2E33; color:white; font-weight:600;">
          Sign Up
        </button>
      `;
    }

    // Fetch & render daily goals
    async function loadDailyGoals() {
      if (!userId) {
        content.innerHTML = "<p>Please sign in first.</p>";
        return;
      }
      content.innerHTML = "<p>Loading tasks...</p>";

      try {
        const res = await fetch(`/api/daily_goals/${userId}`);
        const data = await res.json();

        content.innerHTML = `
          <h3>Daily Goals</h3>
          <ul id="taskList" class="task-list">
            ${data.map(task => `
              <li>
                <input type="checkbox" data-id="${task._id}" ${task.completed ? "checked" : ""}>
                <span>${task.title}</span>
                <button class="delete" data-id="${task._id}">ðŸ—‘</button>
              </li>
            `).join("")}
          </ul>
          <div class="add-task">
            <input type="text" id="newTask" placeholder="New task">
            <button id="addTaskBtn">Add Task</button>
          </div>
        `;

        // Check/uncheck
        document.querySelectorAll("#taskList input[type=checkbox]").forEach(cb => {
          cb.addEventListener("change", async e => {
            const id = e.target.dataset.id;
            await fetch(`/api/daily_goals/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ completed: e.target.checked })
            });
          });
        });

        // Delete
        document.querySelectorAll(".delete").forEach(btn => {
          btn.addEventListener("click", async e => {
            const id = e.target.dataset.id;
            await fetch(`/api/daily_goals/${id}`, { method: "DELETE" });
            loadDailyGoals();
          });
        });

        // Add
        document.getElementById("addTaskBtn").addEventListener("click", async () => {
          const title = document.getElementById("newTask").value.trim();
          if (!title) return;
          await fetch(`/api/daily_goals`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, user: userId })
          });
          document.getElementById("newTask").value = "";
          loadDailyGoals();
        });

      } catch (err) {
        console.error(err);
        content.innerHTML = "<p>Error loading tasks</p>";
      }
    }
  </script>
</body>
</html>
